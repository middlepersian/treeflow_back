{% extends "base.html" %} {% block content %}
<button class="p-2 bg-blue-900 rounded text-white font-bold" id="center">Center</button>
<svg id="svgCanvas" viewbox="0 0 800 600" width="100%" height="100%">
  <defs>
    <marker
      id="arrowhead"
      viewBox="0 0 60 60"
      refX="60"
      refY="30"
      markerUnits="strokeWidth"
      markerWidth="5"
      markerHeight="5"
      orient="auto"
    >
      <path d="M 0 0 L 60 30 L 0 60 z" fill="#800000" />
    </marker>
    <marker
      id="arrowhead"
      markerWidth="4"
      markerHeight="5"
      refX="60"
      refY="3.5"
      orient="a"
    >
      <polygon points="0 0, 10 3.5, 0 7" />
    </marker>
  </defs>
  {% for token in tokens %} {% if token.number != null %}
  <g
    class="p-2 rounded fill-slate-500 hover:fill-slate-900 cursor-pointer"
    id="{{token.id}}"
  >
    <circle
      id="{{token.id}}"
      cx="{{token.xpos}}"
      cy="35"
      class="hover:fill-black hover:stroke-none"
      r="2.5"
      fill="white"
      stroke="black"
    />
    <text x="{{token.xpos}}" y="50" font-family="Verdana" font-size="12">
      {{token.transcription}}
    </text>
  </g>
  {% endif %} {% endfor %}
</svg>

<form id="form"></form>
{{ tokens | json_script:"tokenData" }}
<script>
  // Variables to hold the current position and scale of the viewbox
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.getElementById("svgCanvas");
  const form = document.getElementById("form");
  const pt = svg.createSVGPoint();
  let panning = true;
  let creating = false;
  let currentX = 0;
  let currentY = 0;
  let currentZoom = 1;
  let fromTokenId = null;

  function cursorPoint(evt) {
    pt.x = evt.clientX;
    pt.y = evt.clientY;
    return pt.matrixTransform(svg.getScreenCTM().inverse());
  }

  const tokenData = JSON.parse(
    document.getElementById("tokenData").textContent
  );

  document.querySelectorAll("circle").forEach((item) =>
    item.addEventListener("click", (event) => {
      console.log(`Circle ${event.target.id} clicked`);
      if (!creating) {
        creating = true;
        fromTokenId = event.target.id;
        return;
      }
      if (creating) {
        const tokenTo = event.target.id;
        console.log(`creating arc from ${fromTokenId} to ${tokenTo}`);
        if (tokenTo) {
          const path = document.createElementNS(svgNS, "path");
          const arcDefinition = createBezierArc(
            tokenData.find((e) => e.id === fromTokenId).xpos,
            32.5,
            tokenData.find((e) => e.id === tokenTo).xpos,
            32.5
          );

          path.setAttribute("d", arcDefinition);
          path.setAttribute("fill", "none");
          path.setAttribute("stroke", "black");
          path.setAttribute("stroke-width", "1.5");
          path.setAttribute("marker-end", "url(#arrowhead)");
          path.setAttribute("data-from", fromTokenId);
          path.setAttribute("data-to", tokenTo.id);
          path.addEventListener("click", (event) => {
            console.log("Path clicked");
          });
          svg.appendChild(path);
          const inputField = document.createElement("input");
          inputField.setAttribute("type", "hidden");
          inputField.setAttribute("name", "dependencies");
          inputField.setAttribute(
            "value",
            JSON.stringify({
              from_token_id: fromTokenId,
              to_token_id: tokenTo,
            })
          );
          form.appendChild(inputField);
          creating = false;
          fromTokenId = null;
          const tempPaths = document.getElementsByClassName(pathClass);
          while (tempPaths.length > 0) {
            tempPaths[0].parentNode.removeChild(tempPaths[0]);
          }

        }
      }
    })
  );

  svg.addEventListener("mousemove", (event) => {
    if (!creating) {
      return;
    }
    var loc = cursorPoint(event);
    const mouseX = loc.x;
    const mouseY = loc.y - 5;
    const pathClass = "temp-path";
    const tempPaths = document.getElementsByClassName(pathClass);
    while (tempPaths.length > 0) {
      tempPaths[0].parentNode.removeChild(tempPaths[0]);
    }
    const path = document.createElementNS(svgNS, "path");
    const arcDefinition = createBezierArc(
      tokenData.find((e) => e.id === fromTokenId).xpos,
      35,
      mouseX,
      mouseY
    );
    path.setAttribute("d", arcDefinition);
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", "black");
    path.setAttribute("stroke-width", "1");
    path.setAttribute("marker-end", "url(#arrowhead)");
    path.classList.add("temp-path");
    svg.appendChild(path);
  });

  function createBezierArc(x1, y1, x2, y2, upwards = true) {
    const cp1x = x1;
    const cp2x = x2;
    const arcHeight = Math.abs(x1 - x2);
    const cp1y = y1 - (upwards ? arcHeight : -arcHeight);
    const cp2y = y2 - (upwards ? arcHeight : -arcHeight);
    return `M ${x1},${y1} C ${cp1x},${cp1y} ${cp2x},${cp2y} ${x2},${y2}`;
  }

  tokenData.forEach((token) => {
    token.dependencies?.forEach((dep) => {
      if (!dep.to_token_id) {
        return;
      }
      const depPos = tokenData.find((e) => e.id === dep.to_token_id.id).xpos;
      const path = document.createElementNS(svgNS, "path");
      const arcDefinition = createBezierArc(token.xpos, 32.5, depPos, 32.5);
      path.setAttribute("d", arcDefinition);
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", "black");
      path.setAttribute("stroke-width", "1.5");
      path.setAttribute("class", "hover:stroke-red-500 cursor-pointer");
      path.setAttribute("marker-end", "url(#arrowhead)");
      path.setAttribute("data-from", token.id);
      path.setAttribute("data-to", dep.to_token_id.id);
      path.addEventListener("click", (event) => {
        console.log("Path clicked");
      });
      svg.appendChild(path);
    });
  });

  function setViewBox() {
    if (!panning) {
      return;
    }
    svg.setAttribute(
      "viewBox",
      `${currentX} ${currentY} ${800 / currentZoom} ${600 / currentZoom}`
    );
  }

  svg.onmousedown = function (event) {
    const startX = event.clientX;
    const startY = event.clientY;
    const startViewBoxX = currentX;
    const startViewBoxY = currentY;

    function onMouseMove(event) {
      currentX =
        startViewBoxX + (event.clientX - startX) * currentZoom * (1 / 3);
      currentY =
        startViewBoxY + (event.clientY - startY) * currentZoom * (1 / 3);
      setViewBox();
    }

    function onMouseUp() {
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    }

    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
  };

  svg.onwheel = function (event) {
    event.preventDefault();
    const zoomIntensity = 0.1;
    const wheelDelta = event.deltaY < 0 ? 1 : -1;
    const zoom = Math.exp(wheelDelta * zoomIntensity);
    currentZoom *= zoom;
    setViewBox();
  };

  // give the center button the functionality to center the viewbox on all Elements in the svg
  document.getElementById("center").onclick = function () {
    const bbox = svg.getBBox();
    currentX = bbox.x - 10;
    currentY = bbox.y - 10;
    currentZoom = 1;
    setViewBox();
  };
  

  // Initialize the viewbox
  const bbox = svg.getBBox();
    currentX = bbox.x - 10;
    currentY = bbox.y - 10;
    currentZoom = 1;
    setViewBox();

</script>
{% endblock content %}
