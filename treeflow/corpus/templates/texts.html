{% extends "base.html" %}
{% load static i18n %}
{% block content %}

<div class="overflow-x-auto">
  <table class="min-w-full bg-white">
    <thead class="text-white bg-gray-800">
      <tr>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans '' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Title' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Identifier' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Sigle' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Sources' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Genre' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Version' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Stage' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Tokens' %}</th>
        {% if request.user.is_authenticated %}
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Main Text View' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Sentences View' %}</th>
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Tokens View' %}</th>
        {% endif %}
        <!--
        <th class="px-6 py-3 text-xs font-medium tracking-wider text-center uppercase">{% trans 'Created At' %}</th> -->
      </tr>
    </thead>
    <tbody class="text-gray-700">
      {% for text in texts %}
        {% csrf_token %}
        <tr class="border-b">
          <td class="px-6 py-4 text-center whitespace-nowrap">
              <div>
                {{ forloop.counter }}
              </div>
          </td>
        <!-- Title -->
        <td class="px-6 py-4 whitespace-nowrap">
          {% if request.user.is_authenticated %}
            <input type="text" name="title"
              value="{{ text.title }}"
              hx-post="{% url 'corpus:update_text' text.id %}"
              hx-trigger="keyup changed delay:500ms"
              hx-indicator="#loadingIndicator{{ text.id }}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              class="block w-full mt-1 text-center rounded-md shadow-sm form-input" />
          {% else %}
            <span class="block w-full mt-1 text-center text-blue-500"><a href="{% url 'corpus:sections' text_id=text.id %}">{{ text.title }}</a></span>
          {% endif %}


           <!-- Identifier -->
        <td class="px-6 py-4 whitespace-nowrap">
          {% if request.user.is_authenticated %}
            <input type="text" name="identifier"
              value="{{ text.identifier }}"
              hx-post="{% url 'corpus:update_text' text.id %}"
              hx-trigger="keyup changed delay:500ms"
              hx-indicator="#loadingIndicator{{ text.id }}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              class="block w-full mt-1 text-center rounded-md shadow-sm form-input" />
          {% else %}
            <span class="block w-full mt-1 text-center">{{ text.identifier }}</span>
          {% endif %}
        </td>

        <!-- Sigle -->
        <td class="px-6 py-4 whitespace-nowrap">
          {% if request.user.is_authenticated %}
            <input type="text" name="series"
              value="{{ text.series }}"
              hx-post="{% url 'corpus:update_text' text.id %}"
              hx-trigger="keyup changed delay:500ms"
              hx-indicator="#loadingIndicator{{ text.id }}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              class="block w-full mt-1 text-center rounded-md shadow-sm form-input" />
          {% else %}
            <span class="block w-full mt-1 text-center">{{ text.series }}</span>
          {% endif %}
        </td>
          <!-- Sources -->
          <td class="px-6 py-4 text-center whitespace-nowrap">
            {{ text.sources.all|join:", " }}
          </td>

        <!-- Genre -->
        <td class="px-6 py-4 whitespace-nowrap">
          {% if request.user.is_authenticated %}
            <input type="text" name="label"
              value="{{ text.label }}"
              hx-post="{% url 'corpus:update_text' text.id %}"
              hx-trigger="keyup changed delay:500ms"
              hx-indicator="#loadingIndicator{{ text.id }}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              class="block w-full mt-1 text-center rounded-md shadow-sm form-input" />
          {% else %}
            <span class="block w-full mt-1 text-center">{{ text.label }}</span>
          {% endif %}
        </td>

        <!-- Version -->
        <td class="px-6 py-4 whitespace-nowrap">
          {% if request.user.is_authenticated %}
            <input type="text" name="version"
              value="{{ text.version }}"
              hx-post="{% url 'corpus:update_text' text.id %}"
              hx-trigger="keyup changed delay:500ms"
              hx-indicator="#loadingIndicator{{ text.id }}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              class="block w-full mt-1 text-center rounded-md shadow-sm form-input" />
          {% else %}
            <span class="block w-full mt-1 text-center">{{ text.version }}</span>
          {% endif %}
        </td>
        <!-- Stage -->
        <td class="px-6 py-4 whitespace-nowrap">
          {% if request.user.is_authenticated %}
            <input type="text" name="stage"
              value="{{ text.stage }}"
              hx-post="{% url 'corpus:update_text' text.id %}"
              hx-trigger="keyup changed delay:500ms"
              hx-indicator="#loadingIndicator{{ text.id }}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              class="block w-full mt-1 text-center rounded-md shadow-sm form-input" />
          {% else %}
            <span class="block w-full mt-1 text-center">{{ text.stage }}</span>
          {% endif %}
        </td>         


          <!-- Tokens -->
          <td class="px-6 py-4 text-center whitespace-nowrap">
            {{ text.token_count }}
          </td>
        {% if request.user.is_authenticated %}

          <!-- Main Text View-->
          <td class="px-6 py-4 text-center whitespace-nowrap">
            <a href="{% url 'corpus:sections' text_id=text.id %}">&#128065;</a>
          </td>


          <!-- Sentences View-->
          <td class="px-6 py-4 text-center whitespace-nowrap">
            <a href="{% url 'corpus:sentences' text_id=text.id %}">&#128065;</a>
          </td>

          <!-- Tokens View-->
          <td class="px-6 py-4 text-center whitespace-nowrap">
            <a href="{% url 'corpus:tokens' text_id=text.id %}">&#128065;</a>
          </td>

          {% endif %}
          <!-- Created At 
          <td class="px-6 py-4 text-center whitespace-nowrap">
            {{ text.created_at|date:"Y-m-d H:i" }}
          </td> -->
        </tr>
      {% endfor %}
      {% if texts|length == 0 %}
      <tr>
        <td colspan="11" class="px-6 py-4 text-sm font-medium text-center whitespace-nowrap">No texts available.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>




<script>

document.body.addEventListener('htmx:afterRequest', function (event) {
    // Function to change the input field color based on the response status
    function changeInputFieldColor(inputField, isSuccess) {
      if (inputField) {
        inputField.style.backgroundColor = isSuccess ? 'lightgreen' : 'salmon'; // Success: light green; Failure: salmon
        // Reset the color back to original after a delay
        setTimeout(function () {
          inputField.style.backgroundColor = ''; // Reset to original color
        }, 2000); // Adjust delay as needed
      }
    }

    // Check if the event target is part of the form interaction
    if (event.detail.elt.name === 'title' || event.detail.elt.name === 'identifier' || event.detail.elt.name === 'series' || event.detail.elt.name === 'label' || event.detail.elt.name === 'version' || event.detail.elt.name === 'stage') {
      // Parse the response
      var response = JSON.parse(event.detail.xhr.responseText);

      // Change the input field color based on the response
      changeInputFieldColor(event.detail.elt, response.status === 'success');
    }
  });


</script>

{% endblock %}