{% load static %}
{% load i18n %}

{% block content %}
<div class="col-span-4 sticky top-0 h-screen">


  <!-- Selector container with max-width and margin auto for horizontal centering -->
  <div class="flex flex-row justify-start w-full px-4 lg:max-w-lg mx-auto">
    <select name="source_id" id="sourceSelector" class="w-full p-2 border rounded">
      {% for source in manuscripts %}
        <option value="{{ source.id }}">{{ source.identifier }}</option>
      {% endfor %}
    </select>
    <select name="image_id" id="imageSelector" class="w-full p-2 border rounded" onchange="openNewImage()">
    </select>
  </div>
<!-- OpenSeaDragon viewer -->
  <div id="viewer" class="flex flex-col w-full h-full">
    <div id="openseadragon" class="flex h-full w-full"></div>
    <script type="text/javascript">

    let viewer;
    let currentImage = "{{ manuscript_image }}";
    // check if currentImage is "{{ manuscript_image }}"; and  update the selectors
    let sourceSelector = document.getElementById('sourceSelector');
    let imageSelector = document.getElementById('imageSelector');
    let sourceId = sourceSelector.value;
    let imageId = imageSelector.value;
    // split the currentImage to get the sourceId and imageId
    if (currentImage) {
      let splitImage = currentImage.split('_');
      sourceId = splitImage[0];
      imageId = splitImage[1];
    }


    document.addEventListener('DOMContentLoaded', function () {
      if (currentImage) {

        // check if currentImage is "{{ manuscript_image }}"; and  update the selectors
        let sourceSelector = document.getElementById('sourceSelector');
        let imageSelector = document.getElementById('imageSelector');
        let sourceId = sourceSelector.value;
        let imageId = imageSelector.value;

        initViewer(); // Initialize viewer with the first manuscript image on load

      }
      setImages();
    });

    function openNewImage() {
      let imageID = event.target.value;
      if (imageID == "") {
        return;
      }
      let imageIdentifier = event.target.selectedOptions[0].text;
      if (!imageIdentifier) {
        return;
      }
      currentImage = imageIdentifier;
      initViewer();
    }

    function initViewer() {
      if (currentImage) {
        // Check if the image is available on the IIIF server
        fetch(`https://images.cceh.uni-koeln.de/iipsrv?IIIF=/nfs/cceh/projects/images-mpcd/${currentImage}.tif/info.json`)
          .then(response => {
            if (response.ok) {
              // Image is available, initialize the viewer
              if (!viewer) {
                viewer = OpenSeadragon({
                  id: "openseadragon",
                  prefixUrl: "//openseadragon.github.io/openseadragon/images/",
                  tileSources: `https://images.cceh.uni-koeln.de/iipsrv?IIIF=/nfs/cceh/projects/images-mpcd/${currentImage}.tif/info.json`,
                  showNavigator: true,
                });
              }
              viewer.open(
                `https://images.cceh.uni-koeln.de/iipsrv?IIIF=/nfs/cceh/projects/images-mpcd/${currentImage}.tif/info.json`
              );
            } else {
              // Image is not available, show a message or handle it as needed
              console.log('Image not available');
            }
          });
      } 
    }

    function setImages() {
      var sourceId = document.getElementById('sourceSelector').value;
      fetch(`/corpus/get-images/${sourceId}/`)
        .then(response => response.json())
        .then(data => {
          var imageSelector = document.getElementById('imageSelector');
          imageSelector.innerHTML = '';
          if (data.length === 0) {
            var option = document.createElement('option');
            option.selected = true;
            option.value = '';
            option.textContent = 'No images available';
            imageSelector.appendChild(option);
            imageSelector.selectedIndex = 0; // Automatically select the 'No images available' option
          } else {
            data.forEach(image => {
              var option = document.createElement('option');
              option.value = image.id;
              option.textContent = image.identifier;
              imageSelector.appendChild(option);
            });
          }
          // Initialize the viewer with the first image from the list
          currentImage = data[0].identifier;
          initViewer();
        });
    }

  document.getElementById('sourceSelector').addEventListener('change', setImages);
  // Call the setImages function when the page is loaded
  document.addEventListener('DOMContentLoaded', setImages);
  </script>
  </div>
</div>



{% endblock %}