{% extends 'base.html' %}
{% load static tailwind_tags i18n %}

{% block content %}

<div class="flex flex-row h-full overflow-y-hidden">
  <!-- Sidebar -->
  <div class="w-1/8 bg-gray-100 h-full flex flex-col">
    <form><input type="hidden" id="text-id" name="text_id" value="{{ selected_text_id }}"></form>
    <div class="flex-none max-w-xs p-2">
      {% include 'text_dropdown.html' with text_id=selected_text_id %}
    </div>

    {% if request.user.is_authenticated %}
      <div class="flex-none max-w-xs p-2">
        <div id="selection-panel">
          <h2 class="m-0 text-lg font-bold text-left">{% trans 'Token Selection' %}</h2>
          <span>
            <span id="token-count-sg" class="hidden">1 {% trans 'token' %}</span>
            <span id="token-count-pl"><span>0</span> {% trans 'tokens' %}</span>
          </span>
          <span id="sentence-count" class="hidden">
            (in
            <span id="sentence-count-sg" class="hidden">1 {% trans 'sentence' %}</span>
            <span id="sentence-count-pl"><span>0</span> {% trans 'sentences' %}</span>)
          </span>
        </div>

        <ul>
          <li>
            <button id="stop-selecting" onclick="this.dispatchEvent(new Event('tokens-stop-selecting', {bubbles: true}))">[s] Stop selecting</button>
            <button id="start-selecting" class="hidden" onclick="this.dispatchEvent(new Event('tokens-start-selecting', {bubbles: true}))">[s] Start selecting</button>
          </li>
          <li><button onclick="this.dispatchEvent(new Event('tokens-clear-selection', {bubbles: true}))">[x] Clear selection</button></li>
          <li><button>[ctrl-c] Copy token text</button></li>
        </ul>

        <form hx-include="#text-id ">
          <input type="hidden" name="tokens" value="">
          <ul hx-include="#text-id,input[name='tokens']">
              <li><button hx-get="/corpus/load_section_modal_create/" hx-target="body" hx-swap="beforeend">&rarr; Create new section</button></li>
              <li><button>&rarr; Move tokens</button></li>
              <li><button>&rarr; Edit tokens</button></li>
              <li><button>&rarr; Delete tokens</button></li>
          </ul>
        </form>
      </div>
    {% endif %}

    <div class="bg-gray-200 shadow-md flex-grow">
      <div class="flex flex-col justify-start gap-2 p-2">
        <h2 class="m-0 text-lg font-bold text-left">{% trans 'Select Section Type' %}</h2>

        <select id="section-type-selector" name="section_type" hx-get="{% url 'corpus:get_sections_by_type' %}"
          hx-target="#sectionList" hx-trigger="load, change" hx-include="#text-id, #section-type-selector"
          hx-indicator="#loadingIndicator" hx-swap="innerHTML">
          {% for section_type in section_types %}
          <option value="{{ section_type }}">{{ section_type|title }}</option>
          {% endfor %}
        </select>
        <div id="loadingIndicator" class="hidden">Loading...</div>
      </div>
    </div>

    <div id="sectionList" class="sections-container pl-2 overflow-y-scroll bg-gray-200 h-full scrollbar-thin">
    </div>
  </div>

  <div class="w-2/4 overflow-y-scroll scrollbar-thin">

    {% for sentence in sentence_sections %}
      <div class="flex items-center gap-2 p-2 mb-2 bg-white shadow token-container">
        <div id="{{ sentence.id }}" class="mr-1 font-bold select-none">
          <a href="{% url 'corpus:ud_editor' sentence.id %}"
            class="text-main hover:text-main-dark">{{sentence.number|default:'?' }}</a>
        </div>

        {% if request.user.is_authenticated %}
          <div class="flex-grow cursor-default">
            {% for token in sentence.prefetched_tokens %}
              <span class="token inline-block rounded px-0 m-0"
                    data-token-id="{{ token.id }}" data-sentence-id="{{ sentence.id }}">{{ token.transcription }}</span>
            {% endfor %}
          </div>

          <div>
            <button onclick="location.href='{% url 'corpus:sentence' sentence.id %}'"
              class="bg-blue-400 hover:bg-blue-500 text-xs font-bold text-white py-1 px-2 rounded">
              <span>Edit</span>
            </button>
          </div>

        {% else %}
          <div>
            {% for token in sentence.prefetched_tokens %}
              <span>{{ token.transcription }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>
        {% trans 'No sentence sections found for this text.' %}
      </p>
    {% endfor %}
  </div>

  <!-- Right Column for Image -->
  <div id="iiif-viewer" class="w-1/2 m-2">
    {% include 'components/OpenSeaDragon.html' with sources=manuscripts manuscript_image=manuscript_image %}
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const bgSelected = "bg-green-200";
    const selected = [];

    let selectionActive = true;

    const show = (elemId) => {
      document.getElementById(elemId)?.classList.remove("hidden");
    }

    const hide = (elemId) => {
      document.getElementById(elemId)?.classList.add("hidden");
    }

    const showAndHide = (showId, hideId) => {
      show(showId);
      hide(hideId);
    }

    const select = (elem) => {
      selected.push(elem);
      elem.classList.add(bgSelected);
    }

    const deselect = (elem) => {
      deselectAt(selected.indexOf(elem));
    }

    const deselectAt = (idx) => {
      if (idx >= 0) {
        const [elem] = selected.splice(idx, 1);
        elem?.classList.remove(bgSelected);
      }
    }

    const toggle = (elem) => {
      selected.includes(elem) ? deselect(elem) : select(elem);
    }

    const updatePanel = () => {
      document.querySelector("input[name='tokens']").value = selected.map((e) => e.dataset.tokenId).join(",")

      if (selected.length === 1) {
        showAndHide("token-count-sg", "token-count-pl");
      } else {
        showAndHide("token-count-pl", "token-count-sg")
        document.getElementById("token-count-pl").firstChild.textContent = selected.length;
      }

      if (selected.length === 0) {
        hide("sentence-count")
      } else {
        show("sentence-count")
        const sentenceIds = selected
          .map((elem) => elem.dataset.sentenceId)
          .filter((value, index, array) => array.indexOf(value) === index);
        if (sentenceIds.length === 1) {
          showAndHide("sentence-count-sg", "sentence-count-pl");
        } else {
          showAndHide("sentence-count-pl", "sentence-count-sg");
          document.getElementById("sentence-count-pl").firstChild.textContent = sentenceIds.length;
        }
      }

      if (selectionActive) {
        showAndHide("stop-selecting", "start-selecting");
      } else {
        showAndHide("start-selecting", "stop-selecting");
      }
    }

    const getSelectedTokens = (selection) => {
      const tokens = [];
      for (let i = 0; i < selection.rangeCount; i++) {
        const range = selection.getRangeAt(i);
        const container = range?.commonAncestorContainer;
        switch (container.nodeType) {
          case (Node.ELEMENT_NODE):
            container.querySelectorAll(".token").forEach((elem) => {
              if (range.intersectsNode(elem)) tokens.push(elem);
            });
            break;
          case (Node.TEXT_NODE):
            const elem = container.parentNode.closest(".token")
            if (elem) tokens.push(elem);
            break;
        }
      }
      return tokens;
    }

    document.querySelectorAll(".token-container").forEach((container) => container.addEventListener("mouseup", () => {
      if (selectionActive) {
        const selection = document.getSelection();
        getSelectedTokens(selection).forEach((token) => toggle(token));
        updatePanel();
        selection.empty();
      }
    }));

    document.addEventListener('tokens-stop-selecting', () => {
      selectionActive = false;
      updatePanel();
    });

    document.addEventListener('tokens-start-selecting', () => {
      selectionActive = true;
      updatePanel();
    });

    document.addEventListener('tokens-clear-selection', () => {
      for (let idx = selected.length - 1; idx >= 0; idx--) {
        deselectAt(idx);
      }
      updatePanel()
    });
  });
</script>

{% endblock %}
