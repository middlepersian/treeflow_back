{% extends 'base.html' %}
{% load static tailwind_tags i18n %}

{% block content %}
<div class="flex flex-row h-full overflow-y-hidden">
  <!-- Sidebar -->
  <div class="w-1/8 bg-gray-100">
    <div class="flex flex-col justify-center gap-2 p-2">
      <!-- Text Dropdown -->
      <div class="flex-none max-w-xs">
        {% include 'text_dropdown.html' with text_id=selected_text_id %}
      </div>
      <!-- Edit Button (Conditionally Rendered for Authenticated Users) -->
      {% if request.user.is_authenticated %}
      <button id="startTokenSelection" class="w-full px-4 py-2 font-bold text-white rounded bg-main hover:bg-off"
        data-mode="select">{% trans 'Start Token Selection' %}</button>
      {% endif %}
    </div>
    <!-- Sidebar Content Including Section Type Selector -->
    <div class="bg-gray-200 shadow-md">
      <!-- Section Type Selector Container -->
      <div id="sectionSelectorContainer" class="flex flex-col justify-center gap-2 p-2">
        <h2 class="m-0 text-lg font-bold">{% trans 'Select Section Type' %}</h2>
        <!-- Hidden input for textId -->
        <input type="hidden" id="textId" name="textId" value="{{ selected_text_id }}">

        <!-- Section Type Selector -->
        <select id="sectionTypeSelector" name="sectionTypeSelector" hx-get="{% url 'corpus:get_sections_by_type' %}"
          hx-target="#sectionList" hx-trigger="load, change" hx-include="#textId, #sectionTypeSelector"
          hx-indicator="#loadingIndicator" hx-swap="innerHTML">
          {% for section_type in section_types %}
          <option value="{{ section_type }}">{{ section_type|title }}</option>
          {% endfor %}
        </select>
        <div id="loadingIndicator" class="hidden">Loading...</div>
      </div>
    </div>
    <!-- Section List -->
    <div id="sectionList" class="sections-container pl-2 overflow-y-scroll bg-gray-200 scrollbar-thin">
      <!-- Sections will be loaded here -->
    </div>

  </div>

  <!-- Content Area for sentences -->
  <div id="sentence-area" class="w-2/4 overflow-y-scroll scrollbar-thin">
    <!-- Loop over sections of type 'sentence' -->
    {% for section in sentence_sections %}
    <!-- Sentence Block starts -->
    <div class="flex items-center p-2 mb-2 bg-white rounded shadow sentence">
      <!-- Display sentence section title or identifier with a fixed width -->
      <div id="{{ section.id }}" class="mr-1 font-bold sentence-identifier w-1/8">
        <a href="{% url 'corpus:ud_editor' section.id %}"
          class="text-main hover:text-main-dark">{{section.number|default:'Untitled' }}</a>
      </div>

      <!-- Sentence content tokens displayed next to the identifier -->
      <div class="flex flex-wrap sentence-content w-2/8">
        {% for token in section.prefetched_tokens %}
        <span class="token inline-block rounded px-1 py-0.5 m-0.5" data-token-id="{{ token.id }}"
          data-section-id="{{ section.id }}">{{ token.transcription }}</span>
        {% endfor %}
      </div>

      {% if request.user.is_authenticated %}
      <div class="mr-1 font-bold sentence-identifier w-1/8">
        <button onclick="location.href='{% url 'corpus:sentence' section.id %}'"
          class="text-sm bg-blue-500 text-white py-1 px-2 rounded">Edit</button>
      </div>
      {% endif %}
    </div>
    {% empty %}
    <p>
      {% trans 'No sentence sections found for this text.' %}
    </p>
    {% endfor %}
  </div>

  <!-- Right Column for Image -->
  <div id="iiif-viewer" class="w-1/2 m-2">
    {% include 'components/OpenSeaDragon.html' with sources=manuscripts manuscript_image=manuscript_image %}
  </div>

  <input type="hidden" id="id_selected_tokens" name="selected_tokens" value />

  <div id="modalContainer"></div>
</div>

<script>
  var textId = '{{ selected_text_id }}'
  console.log('Selected text ID:', textId)
</script>
<!-- Section Navigator -->
<script>
  document.body.addEventListener('htmx:afterSwap', function (event) {
    if (event.detail.target.classList.contains('section-data')) {
      event.stopPropagation(); // Stop event propagation
      const container = event.detail.target;
  
      // Toggle visibility if already loaded
      if (container.getAttribute('data-visible') === 'true') {
        container.style.display = 'none'; // Hide child sections
        container.setAttribute('data-visible', 'false');
      } else {
        container.style.display = 'block'; // Show child sections
        container.setAttribute('data-visible', 'true');
      }
  
      // Try to parse the JSON data if not already loaded
      try {
        const data = JSON.parse(container.innerText);
        container.innerHTML = ''; // Clear the existing content
        // Process and display child sections recursively
        if (data.child_sections) {
          const list = createNestedList(data.child_sections);
          container.appendChild(list);
        }
        // Process and highlight tokens if necessary
        if (data.tokens) {
          highlightSectionTokens(data.tokens);
        }
      } catch (e) {
        console.error("Error parsing JSON:", e);
      }
    }
  });
  
  function createNestedList(sections) {
    const list = document.createElement('ul');
    list.classList.add('child-section-list');
    sections.forEach(section => {
      const item = document.createElement('li');
      item.textContent = section.identifier;
      item.dataset.sectionId = section.id; // Store section ID for token fetching
      item.addEventListener('click', function(event) {
        event.stopPropagation(); // Prevent event from bubbling up to parent elements
        fetchTokensForSection(section.id);
      });
      if (section.child_sections && section.child_sections.length > 0) {
        const childList = createNestedList(section.child_sections); // Recursive call
        item.appendChild(childList);
      }
      list.appendChild(item);
    });
    return list;
  }
  
  function fetchTokensForSection(sectionId) {
    fetch(`/corpus/get-tokens-for-section/${sectionId}/`)
      .then(response => response.json())
      .then(data => {
        if (data.tokens) {
          highlightSectionTokens(data.tokens);
        }
      })
      .catch(error => console.error('Error fetching tokens:', error));
  }
  
  function highlightSectionTokens(tokenIds) {
    const stringTokenIds = tokenIds.map(id => id.toString());
    const tokens = document.querySelectorAll('.token');
    tokens.forEach(token => {
      token.classList.toggle('bg-yellow-300', stringTokenIds.includes(token.dataset.tokenId));
    });
  
    // Scroll to the first highlighted token
    const firstHighlighted = document.querySelector('.token.bg-yellow-300');
    if (firstHighlighted) {
      firstHighlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
  </script>

{% endblock %}