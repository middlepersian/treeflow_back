{% extends 'base.html' %}
{% load static tailwind_tags i18n %}

{% block content %}
<div class="flex flex-row h-full overflow-y-hidden">
  <!-- Sidebar -->
  <div class="w-1/8 bg-gray-100">
    <div class="flex flex-col justify-center gap-2 p-2">
      <!-- Text Dropdown -->
      <div class="flex-none max-w-xs">
        {% include 'text_dropdown.html' with text_id=selected_text_id %}
      </div>
      <!-- Edit Button (Conditionally Rendered for Authenticated Users) -->
      {% if request.user.is_authenticated %}
      <button id="startTokenSelection" class="w-full px-4 py-2 font-bold text-white rounded bg-main hover:bg-off"
        data-mode="select">{% trans 'Start Token Selection' %}</button>
      {% endif %}
    </div>
    <!-- Sidebar Content Including Section Type Selector -->
    <div class="bg-gray-200 shadow-md">
      <!-- Section Type Selector Container -->
      <div id="sectionSelectorContainer" class="flex flex-col justify-center gap-2 p-2">
        <h2 class="m-0 text-lg font-bold">{% trans 'Select Section Type' %}</h2>
        <!-- Hidden input for textId -->
        <input type="hidden" id="textId" name="textId" value="{{ selected_text_id }}">

        <!-- Section Type Selector -->
        <select id="sectionTypeSelector" name="sectionTypeSelector" hx-get="{% url 'corpus:get_sections_by_type' %}"
          hx-target="#sectionList" hx-trigger="load, change" hx-include="#textId, #sectionTypeSelector"
          hx-indicator="#loadingIndicator" hx-swap="innerHTML">
          {% for section_type in section_types %}
          <option value="{{ section_type }}">{{ section_type|title }}</option>
          {% endfor %}
        </select>
        <div id="loadingIndicator" class="hidden">Loading...</div>
      </div>
    </div>
    <!-- Section List -->
    <div id="sectionList" class="sections-container pl-2 overflow-y-scroll bg-gray-200 scrollbar-thin">
      <!-- Sections will be loaded here -->
    </div>

  </div>

  <!-- Content Area for sentences -->
  <div id="sentence-area" class="w-2/4 overflow-y-scroll scrollbar-thin">
    <!-- Loop over sections of type 'sentence' -->
    {% for section in sentence_sections %}
    <!-- Sentence Block starts -->
    <div class="flex items-center p-2 mb-2 bg-white rounded shadow sentence">
      <!-- Display sentence section title or identifier with a fixed width -->
      <div id="{{ section.id }}" class="mr-1 font-bold sentence-identifier w-1/8">
        <a href="{% url 'corpus:ud_editor' section.id %}"
          class="text-main hover:text-main-dark">{{section.number|default:'Untitled' }}</a>
      </div>

      <!-- Sentence content tokens displayed next to the identifier -->
      <div class="flex flex-wrap sentence-content w-2/8">
        {% for token in section.prefetched_tokens %}
        <span class="token inline-block rounded px-1 py-0.5 m-0.5" data-token-id="{{ token.id }}"
          data-section-id="{{ section.id }}">{{ token.transcription }}</span>
        {% endfor %}
      </div>

      {% if request.user.is_authenticated %}
      <div class="mr-1 font-bold sentence-identifier w-1/8">
        <button onclick="location.href='{% url 'corpus:sentence' section.id %}'"
          class="text-sm bg-blue-500 text-white py-1 px-2 rounded">Edit</button>
      </div>
      {% endif %}
    </div>
    {% empty %}
    <p>
      {% trans 'No sentence sections found for this text.' %}
    </p>
    {% endfor %}
  </div>

  <!-- Right Column for Image -->
  <div id="iiif-viewer" class="w-1/2 m-2">
    {% include 'components/OpenSeaDragon.html' with sources=manuscripts manuscript_image=manuscript_image %}
  </div>

  <input type="hidden" id="id_selected_tokens" name="selected_tokens" value />

  <div id="modalContainer"></div>
</div>



<script>
  var textId = '{{ selected_text_id }}'
  console.log('Selected text ID:', textId)
</script>

<!-- Include the JavaScript file for the section_creator.js -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let startTokenId = null;
    let endTokenId = null;
    let isSelectingTokens = false;
    let selectedTokens = [];
    let selectedTokenIds = [];
    let selectedTokenTexts = '';

    // Define deselectAllTokens globally on the window object
    window.deselectAllTokens = function () {
      document.querySelectorAll('.token.bg-green-200').forEach(token => {
        token.classList.remove('bg-green-200');
      });
      // Reset any other relevant state variables here
      startTokenId = null;
      endTokenId = null;
      selectedTokenIds = [];
      selectedTokens = [];
      selectedTokenTexts = '';
      console.log('All tokens have been deselected.');
    };

    var csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    var csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : null;

    if (csrfToken) {
      htmx.config.include = (name, value, el) => {
        if (name === "csrfmiddlewaretoken") {
          return csrfToken;
        }
        return value;
      };
    } else {
      console.error("CSRF token not available");
    }

    function addTokenClickListeners() {
      document.querySelectorAll('.token').forEach(token => {
        token.addEventListener('click', function () {
          if (isSelectingTokens) {
            handleTokenClick(this);
          }
        });
      });
    }

    function handleTokenClick(tokenElement) {
      const tokenId = tokenElement.dataset.tokenId;
      if (startTokenId === null) {
        startTokenId = tokenId;
        tokenElement.classList.add('bg-green-200');
      } else if (endTokenId === null && tokenId !== startTokenId) {
        endTokenId = tokenId;
        highlightTokensBetween(startTokenId, endTokenId);
      }
    }

    function highlightTokensBetween(startId, endId) {
      let inRange = false;
      document.querySelectorAll('.token').forEach(token => {
        if (token.dataset.tokenId === startId || token.dataset.tokenId === endId) {
          inRange = !inRange;
          token.classList.add('bg-green-200');
        }
        if (inRange || token.dataset.tokenId === endId) {
          token.classList.add('bg-green-200');
        }
      });
    }

    document.getElementById('startTokenSelection').addEventListener('click', function () {
      let mode = this.getAttribute('data-mode');
      if (mode === 'select') {
        isSelectingTokens = true;
        this.textContent = 'Finish Token Selection';
        this.setAttribute('data-mode', 'finish');
      } else if (mode === 'finish') {
        isSelectingTokens = false;
        selectedTokens = Array.from(document.querySelectorAll('.token.bg-green-200'));
        selectedTokenIds = selectedTokens.map(token => token.dataset.tokenId);
        selectedTokenTexts = selectedTokens.map(token => token.textContent).join(', ');
        let queryString = `?tokens=${encodeURIComponent(selectedTokenIds.join(','))}&text_id=${encodeURIComponent(textId)}`;
        htmx.ajax('GET', '/corpus/load_section_modal_create/' + queryString, {
          target: '#modalContainer'
        }).then(() => {
          document.getElementById('modalTextId').value = textId;
        });
        this.textContent = 'Start Token Selection';
        this.setAttribute('data-mode', 'select');
      }
    });


    function deselectAllTokens() {
      document.querySelectorAll('.token.bg-green-200').forEach(token => {
        token.classList.remove('bg-green-200');
      });
      startTokenId = null;
      endTokenId = null;
      selectedTokenIds = [];
    }

    document.body.addEventListener('htmx:afterSwap', function (event) {
      if (event.target.id === 'modalContainer') {
        openModal();
      }
    });

    function openModal() {
      let modal = document.getElementById('sectionModal');
      if (modal) {
        modal.classList.remove('hidden');
        document.getElementById('selectedTokensDisplay').textContent = window.selectedTokenTexts || 'No tokens selected';
        bindModalEventListeners(modal);  // Pass the modal element as an argument
      } else {
        console.error('Modal not found in the DOM.');
      }
    }

    function bindModalEventListeners(modal) {  // Receive the modal element as a parameter
      var closeModalButton = modal.querySelector('#closeModalButton');
      if (closeModalButton) {
        closeModalButton.addEventListener('click', closeModal);
      }
    }

    document.body.addEventListener('click', function (event) {
      if (event.target.id === 'closeModalButton') {
        closeModal();
      }
    });

    function closeModal() {
      var modal = document.getElementById('sectionModal');
      if (modal) {
        modal.classList.add('hidden');
        window.deselectAllTokens();
        window.isSelectingTokens = false;
        window.selectedTokenTexts = '';
        document.dispatchEvent(new CustomEvent('modalClosed'));
        console.log('Modal closed and state reset.');
      } else {
        console.error('Attempted to close a modal that does not exist.');
      }
    }

    
    addTokenClickListeners();

    // Define the observer for observing changes in the DOM
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'childList') {
          console.log('A child node has been added or removed.');
        }
      });
    });


    observer.observe(document.body, { childList: true, subtree: true });
  });

</script>


{% endblock %}