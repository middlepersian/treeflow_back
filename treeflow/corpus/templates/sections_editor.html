{% extends "base.html" %}

{% block content %}
<div class="container flex flex-row">
    <!-- Sidebar with Chapter Information -->
    <div class="sidebar w-1/4 bg-gray-100 p-4">
        <h2 class="font-bold text-lg mb-4">Select Section Type</h2>
        <!-- Dropdown Menu for selecting section type -->
        <select id="sectionTypeSelector" class="mb-4">
            {% for section_type in section_types %}
            <option value="{{ section_type }}">{{ section_type|title }}</option>
            {% endfor %}
        </select>
        <!-- Section List Placeholder -->
        <div id="sectionList">
            <!-- Sections will be dynamically loaded here -->
        </div>
    </div>

    <!-- Content Area for sentences -->
    <div class="content w-3/4 p-4">
        <!-- Loop over sections of type 'sentence' -->
        {% for section in sentence_sections %}
        <!-- Sentence Block starts -->
        <div class="sentence mb-2 flex items-center p-2 bg-white shadow rounded">
            <!-- Display sentence section title or identifier with a fixed width -->
            <div class="sentence-identifier w-1/8 font-bold mr-1">
                {{ section.number|default:"Untitled" }}
            </div>
        <!-- Sentence content tokens displayed next to the identifier -->
        <div class="sentence-content w-2/8 flex flex-wrap">
            {% for token in section.prefetched_tokens %}
            <!-- Add data-section-id attribute to each token -->
            <span class="token inline-block rounded px-1 py-0.5 m-0.5" 
                data-token-id="{{ token.id }}" 
                data-section-id="{{ section.id }}"> <!-- Add this line -->
                {{ token.transcription }}
            </span>
            {% endfor %}
        </div>

        </div>
        {% empty %}
        <p>No sentence sections found for this text.</p>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const selector = document.getElementById('sectionTypeSelector');
    const sectionList = document.getElementById('sectionList');
    const textId = '{{ text_id }}';


    function highlightSectionTokens(tokenIds) {
        const tokens = document.querySelectorAll('.token');
        tokens.forEach(token => {
            if (tokenIds.includes(token.dataset.tokenId)) {
                token.classList.add('bg-yellow-200', 'text-black');
            } else {
                token.classList.remove('bg-yellow-200', 'text-black');
            }
        });
    }


    function fetchAndHighlightSectionTokens(sectionId) {
        fetch(`/corpus/get-tokens-for-section/${sectionId}`)
            .then(response => response.json())
            .then(data => {
                const tokenIds = data.tokens; // Assuming the backend sends an array of token IDs
                highlightSectionTokens(tokenIds);

                // Scroll to the first token of this section
                if (tokenIds.length > 0) {
                    const firstTokenId = tokenIds[0];
                    const firstTokenElement = document.querySelector(`.token[data-token-id="${firstTokenId}"]`);
                    if (firstTokenElement) {
                        firstTokenElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching tokens for section:', error);
            });
    }

    function loadChildSections(sectionId, parentDiv) {
        // Check if child sections are already loaded
        const existingChildList = parentDiv.querySelector('.child-section-list');
        if (existingChildList) {
            // Remove the child list to 'close' the section
            parentDiv.removeChild(existingChildList);
            return; // Exit the function
        }
        fetch(`/corpus/get-child-sections/${sectionId}`)
            .then(response => response.json())
            .then(childSections => {
                const childSectionList = document.createElement('div');
                childSectionList.classList.add('child-section-list');

                childSections.forEach(childSection => {
                    const childDiv = document.createElement('div');
                    childDiv.classList.add('child-section-item');
                    childDiv.textContent = childSection.identifier || 'Untitled';
                    childDiv.dataset.sectionId = childSection.id;

                    // Add event listener to prevent event bubbling
                    childDiv.addEventListener('click', function(event) {
                        event.stopPropagation();
                        fetchAndHighlightSectionTokens(childSection.id);
                    });

                    childSectionList.appendChild(childDiv);
                });

                // Check if child sections are already loaded to avoid duplication
                if (!parentDiv.querySelector('.child-section-list')) {
                    parentDiv.appendChild(childSectionList);
                }
            })
            .catch(error => {
                console.error('Error fetching child sections:', error);
            });
    }

    function loadSectionsOfType(sectionType) {
        fetch(`/corpus/get-sections/${textId}/${sectionType}`)
            .then(response => response.json())
            .then(sections => {
                sectionList.innerHTML = '';
                sections.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.classList.add('section-item');
                    sectionDiv.textContent = section.identifier || 'Untitled';
                    sectionDiv.dataset.sectionId = section.id;
                    
                    // Add event listener to load child sections    
                    sectionDiv.addEventListener('click', function() {
                    loadChildSections(section.id, this);
                    fetchAndHighlightSectionTokens(section.id);
                });

                    sectionList.appendChild(sectionDiv);
                });

                if (sections.length === 0) {
                    sectionList.innerHTML = '<p>No sections found for this type.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching sections:', error);
                sectionList.innerHTML = '<p>Error loading sections.</p>';
            });
    }

    selector.addEventListener('change', function () {
        loadSectionsOfType(this.value);
    });

    if (selector.options.length > 0) {
        loadSectionsOfType(selector.options[0].value);
    }
});

</script>

{% endblock content %}
