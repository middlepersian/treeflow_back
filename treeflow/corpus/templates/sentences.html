{% extends "base.html" %}
{% block content %}

<div class="container mx-auto p-4">

    <!-- Form for selecting text -->
    <form action="{% url 'corpus:sentences' %}" method="get" class="mb-4">

        <!-- Text selection dropdown -->
        <div class="mb-3">
            <label for="text-select" class="block text-gray-700 text-sm font-bold mb-2">Choose a text:</label>
            <select name="text_id" id="text-select" onchange="this.form.submit()"
                class="block appearance-none w-full bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Select a text...</option>
                {% for text in texts %}
                <option value="{{ text.id|stringformat:'s' }}" {% if text.id|stringformat:'s' == selected_text_id|stringformat:'s' %} selected {% endif %}>
                    {{ text.title }}
                </option>
</option>
                </option>
                {% endfor %}
            </select>
        </div>
        <noscript><input type="submit" value="Filter" class="btn btn-primary"></noscript>
    </form>

    {% for sentence in sentences %}
    <h3>Sentence ID: {{ sentence.id }}</h3>
    <table>
        <thead class="bg-gray-800 text-white">
            <tr>
                <th class="px-4 py-2">Number</th>
                <th class="px-4 py-2">Number in Sentence</th>
                <th class="px-4 py-2">Sentence</th>
                <th class="px-4 py-2">Transcription</th>
                <th class="px-4 py-2">Transliteration</th>
                <th class="px-4 py-2">Lemmas</th>
                <th class="px-4 py-2">Senses</th>
                <th class="px-4 py-2">POS</th>
                <th class="px-4 py-2">Features</th>
                <th class="px-4 py-2">Insert Before</th>
                <th class="px-4 py-2">Insert After</th>
                <th class="px-4 py-2">Delete Token</th>
            </tr>
        </thead>
        <tbody>
            {% for section_token in sentence.tokens.all %}
                {% with token=section_token.token %}
                {% csrf_token %}

                <p>Token ID: {{ token.id }}</p>

                <tr class="bg-white shadow-lg rounded mb-4 overflow-hidden">
                    <!-- Form for the entire row to edit a token -->
                    <form method="post" action="{% url 'corpus:update_token' token.id %}">
                        <td class="border px-4 py-2">{{ token.number }}</td>
                        <!-- Number in Sentence -->
                        <td class="border px-4 py-2">{{ token.number_in_sentence }}</td>

                        <!-- Transcription -->
                        <td class="border px-4 py-2">
                            <input type="text" name="transcription" value="{{ token.transcription }}"
                                hx-post="{% url 'corpus:update_token' token.id %}" hx-trigger="keyup changed delay:500ms"
                                hx-indicator="#loadingIndicator{{ token.id }}"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                class="shadow border rounded py-2 px-3 text-grey-darker">
                        </td>
                        <!-- Transliteration -->
                        <td class="border px-4 py-2">
                            <input type="text" name="transliteration" value="{{ token.transliteration }}"
                                hx-post="{% url 'corpus:update_token' token.id %}" hx-trigger="keyup changed delay:500ms"
                                hx-indicator="#loadingIndicator{{ token.id }}"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                class="shadow border rounded py-2 px-3 text-grey-darker">
                        </td>

                        <!-- Lemmas -->
                        <td class="border px-4 py-2">
                            {% for lemma in token.lemmas.all %}
                            {{ lemma.word }}
                            {% if not forloop.last %}, {% endif %}
                            {% empty %}
                            _
                            {% endfor %}
                        </td>
                        <!-- Senses -->
                        <td class="border px-4 py-2">
                            {% for sense in token.senses.all %}
                            {{ sense.sense }}
                            {% if not forloop.last %}, {% endif %}
                            {% empty %}
                            _
                            {% endfor %}
                        </td>
                        <!-- POS -->
                        <td id="pos-cell" class="border px-4 py-2" hx-get="{% url 'corpus:pos_feature_form' token.id %}"
                            hx-target="#featureModalContent" hx-trigger="click">
                            <span id="pos-content-{{ token.id }}">
                                <!--show selected POS-->
                                <!-- Show selected POS if available -->
                                {% for pos in token.pos_token.all %}
                                {% if pos.pos %}
                                {{ pos.pos }}
                                {% endif %}
                                {% empty %}
                                _
                                {% endfor %}
                            </span>
                        </td>
                        <!-- Features -->
                        <td id="features-cell" class="border px-4 py-2"
                            hx-get="{% url 'corpus:pos_feature_form' token.id %}" hx-target="#featureModalContent"
                            hx-trigger="click">
                            <span id="features-content-{{ token.id }}">
                                {% for feature in token.feature_token.all %}
                                {{ feature.feature }}={{ feature.feature_value }}{% if not forloop.last %} | {% endif %}
                                {% empty %}
                                _
                                {% endfor %}
                            </span>
                        </td>
                    </form>
                    <!-- Insert Before Button -->
                    <td class="border px-4 py-2">
                        <form method="post" action="{% url 'corpus:insert_before_token' token.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="token_id" value="{{ token.id }}">
                            <input type="hidden" name="page" value="{{ request.GET.page }}">
                            <input type="hidden" name="text_id" value="{{ request.GET.text_id }}">
                            <input type="submit" value="⬆️ Insert"
                                class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
                        </form>
                    </td>
                    <!-- Insert After Button -->
                    <td class="border px-4 py-2">
                        <form method="post" action="{% url 'corpus:insert_after_token' token.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="token_id" value="{{ token.id }}">
                            <!-- Add hidden inputs for 'page' and 'text_id' -->
                            <input type="hidden" name="page" value="{{ request.GET.page }}">
                            <input type="hidden" name="text_id" value="{{ request.GET.text_id }}">
                            <input type="submit" value="⬇️ Insert"
                                class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
                        </form>
                    </td>

                    <!-- Delete Button -->
                    <td class="border px-4 py-2">
                        <form method="post" action="{% url 'corpus:delete_token' token.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="token_id" value="{{ token.id }}">
                            <input type="hidden" name="page" value="{{ request.GET.page }}">
                            <input type="hidden" name="text_id" value="{{ request.GET.text_id }}">
                            <input type="submit" value="❌ Delete"
                                class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
                        </form>
                    </td>
                </tr>
                {% endwith %}
            {% endfor %}
            <tr>
                <td colspan="6" class="text-center py-4">No tokens available for the selected text.</td>
            </tr>
            {% endfor %}
        </table>
        <p>No sentences available.</p>
</div>

<!-- POS and Feature Modal (placed outside the loop) -->
<div class="hidden fixed inset-0 z-50 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" id="featureModal">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg shadow-lg w-96 mx-auto p-4">
            <div id="featureModalContent"></div>
        </div>
    </div>
</div>
{% endblock %}