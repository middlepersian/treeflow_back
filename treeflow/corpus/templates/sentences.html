{% extends "base.html" %}
{% block content %}

<div class="container mx-auto p-4">

  <!-- Form for selecting text -->
  <form action="{% url 'corpus:sentences' %}" method="get" class="mb-4">

    <!-- Text selection dropdown -->
    <div class="mb-3">
      <label for="text-select" class="block text-gray-700 text-sm font-bold mb-2">Choose a text:</label>
      <select name="text_id" id="text-select" onchange="this.form.submit()"
        class="block appearance-none w-full bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
        <option value="">Select a text...</option>
        {% for text in texts %}
        <option value="{{ text.id|stringformat:'s' }}" {% if text.id|stringformat:'s' == selected_text_id|stringformat:'s' %} selected {% endif %}>
          {{ text.title }} - {{ text.identifier }}
        </option>
        {% endfor %}
      </select>
    </div>
    <noscript><input type="submit" value="Filter" class="btn btn-primary"></noscript>
  </form>


  <table class="table-fixed w-full">
    <thead class="bg-gray-800 text-white">
      <tr>
        <th class="w-1/8 px-4 py-2">Token Number</th>
        <th class="w-1/4 px-4 py-2">Transcription</th>
        <th class="w-1/4 px-4 py-2">Transliteration</th>
        <th class="w-1/6 px-4 py-2">Lemmas</th>
        <th class="w-1/12 px-4 py-2">Insert Before</th>
        <th class="w-1/12 px-4 py-2">Insert After</th>
        <th class="w-1/12 px-4 py-2">Delete Token</th>
      </tr>
    </thead>
    <tbody>


    {% for sentence, tokens in sentences_with_tokens %}
    <!-- Sentence Header Row -->
    <tr class="bg-blue-100">
      <td colspan="7" class="px-4 py-2 font-bold">Sentence Identifier: {{ sentence.identifier }}</td>
    </tr>
    <tr class="bg-blue-100">
      <td colspan="7" class="px-4 py-2 font-bold">Sentence Translation: {{ sentence.senses.0 }}</td>
    </tr>
    <tr class="bg-blue-100">
      <td colspan="7" class="px-4 py-2 font-bold">Sentence ID: {{ sentence.id }}</td>
    </tr>
      {% for token in sentence.tokens.all %}

      <tr class="bg-white shadow-lg rounded mb-4 overflow-hidden">
        {% csrf_token %}
          <td class="border px-4 py-2 text-center">{{ token.number }}</td>
          <!-- Transcription -->
          <td class="border px-4 py-2">
            <input type="text" name="transcription" value="{{ token.transcription }}"
              hx-post="{% url 'corpus:update_token' token.id %}" hx-trigger="keyup changed delay:500ms"
              hx-indicator="#loadingIndicator{{ token.id }}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              class="shadow border rounded py-2 px-3 text-grey-darker">
          </td>
          <!-- Transliteration -->
          <td class="border px-4 py-2">
            <input type="text" name="transliteration" value="{{ token.transliteration }}"
              hx-post="{% url 'corpus:update_token' token.id %}" hx-trigger="keyup changed delay:500ms"
              hx-indicator="#loadingIndicator{{ token.id }}"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              class="shadow border rounded py-2 px-3 text-grey-darker">
          </td>
          <!-- Lemmas --> 
          <td class="border px-4 py-2">
            {% for lemma in token.lemmas.all %}
            {{ lemma.word }}
            {% if not forloop.last %}, {% endif %}
          {% empty %}
            _
          {% endfor %}
          </td>          <!-- Insert Before Button -->
          <td class="border px-4 py-2">
            <form method="post" action="{% url 'corpus:insert_before_token' token.id %}">
              {% csrf_token %}
              <input type="hidden" name="token_id" value="{{ token.id }}">
              <input type="hidden" name="page" value="{{ request.GET.page }}">
              <input type="hidden" name="text_id" value="{{ request.GET.text_id }}">
              <input type="submit" value="⬆️ Insert"
                class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
            </form>
          </td>
          <!-- Insert After Button -->
          <td class="border px-4 py-2">
            <form method="post" action="{% url 'corpus:insert_after_token' token.id %}">
              {% csrf_token %}
              <input type="hidden" name="token_id" value="{{ token.id }}">
              <!-- Add hidden inputs for 'page' and 'text_id' -->
              <input type="hidden" name="page" value="{{ request.GET.page }}">
              <input type="hidden" name="text_id" value="{{ request.GET.text_id }}">
              <input type="submit" value="⬇️ Insert"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
            </form>
          </td>
          <!-- Delete Button -->
          <td class="border px-4 py-2">
            <form method="post" action="{% url 'corpus:delete_token' token.id %}">
              {% csrf_token %}
              <input type="hidden" name="token_id" value="{{ token.id }}">
              <input type="hidden" name="page" value="{{ request.GET.page }}">
              <input type="hidden" name="text_id" value="{{ request.GET.text_id }}">
              <input type="submit" value="❌ Delete"
                class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
            </form>
          </td>

      </tr>
      {% endfor %}
      {% endfor %}
    </tbody>
  </table>

</div>

<!-- POS and Feature Modal (placed outside the loop) -->
<div class="hidden fixed inset-0 z-50 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" id="featureModal">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg shadow-lg w-96 mx-auto p-4">
            <div id="featureModalContent"></div>
        </div>
    </div>
</div>
    

<!-- Include the pagination template with the required context variable -->
{% include 'pagination.html' %}

{% endblock %}


